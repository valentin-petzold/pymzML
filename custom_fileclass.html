<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>4.6. Implementing an own file class &mdash; pymzML 2.5.3 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=0bbe9fa5"></script>
        <script src="_static/doctools.js?v=888ff710"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="4.7. Example Scripts" href="example_scripts.html" />
    <link rel="prev" title="4.1. Writing and Reading igzip files" href="index_gzip.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            pymzML
          </a>
              <div class="version">
                2.5.3
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="quick_start.html">2. Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="modules.html">3. pymzML module content</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="examples.html">4. Examples and Advanced Usage</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="index_gzip.html">4.1. Writing and Reading igzip files</a></li>
<li class="toctree-l2"><a class="reference internal" href="index_gzip.html#generalized-seekable-index-gzip-writer">4.2. Generalized Seekable index Gzip Writer</a></li>
<li class="toctree-l2"><a class="reference internal" href="index_gzip.html#generalized-seekable-index-gzip-reader">4.3. Generalized Seekable index Gzip Reader</a></li>
<li class="toctree-l2"><a class="reference internal" href="index_gzip.html#practical-example-moby-dick">4.4. Practical Example: Moby Dick</a></li>
<li class="toctree-l2"><a class="reference internal" href="index_gzip.html#igzip-file-format-specification">4.5. igzip file format specification</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">4.6. Implementing an own file class</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#creating-the-wrapper">4.6.1. Creating the wrapper</a></li>
<li class="toctree-l3"><a class="reference internal" href="#enabling-the-wrapper">4.6.2. Enabling the wrapper</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="example_scripts.html">4.7. Example Scripts</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="suppl_material.html">5. Supplemental Material</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">pymzML</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="examples.html"><span class="section-number">4. </span>Examples and Advanced Usage</a></li>
      <li class="breadcrumb-item active"><span class="section-number">4.6. </span>Implementing an own file class</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/custom_fileclass.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="implementing-an-own-file-class">
<h1><span class="section-number">4.6. </span>Implementing an own file class<a class="headerlink" href="#implementing-an-own-file-class" title="Link to this heading"></a></h1>
<p>In  order to make pymzML accept other kinds of mzML data (e.g databases), one can
implement an own wrapper similiar to the ones discussed before.
In the following, an example for building and accessing a SQL database containing single spectra will be shown.</p>
<section id="creating-the-wrapper">
<h2><span class="section-number">4.6.1. </span>Creating the wrapper<a class="headerlink" href="#creating-the-wrapper" title="Link to this heading"></a></h2>
<p>At first, a database with a specific layout needs to be created. Here, we use a single mzML file and store each spectrum in a table with 2 columns, one for the identifier and one for the xml element of the spectrum in form of a string.</p>
<p>Database creation:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pymzml</span> <span class="kn">import</span> <span class="n">spec</span>
<span class="kn">from</span> <span class="nn">pymzml.run</span> <span class="kn">import</span> <span class="n">Reader</span>

<span class="k">def</span> <span class="nf">create_database_from_file</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">mzml_path</span><span class="p">):</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_name</span><span class="o">+</span><span class="s1">&#39;.db&#39;</span><span class="p">)</span>
    <span class="n">Run</span> <span class="o">=</span> <span class="n">Reader</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">mzml_path</span><span class="p">))</span>
    <span class="k">with</span> <span class="n">conn</span><span class="p">:</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;CREATE TABLE Spectra(ID INT, xml TEXT)&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">Run</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">ID</span><span class="p">,</span> <span class="n">spec</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO Spectra VALUES(?, ?)&quot;</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span>
</pre></div>
</div>
<p>After this, we need to implement a class, which needs to implement the __getitem__ function for random access, and
a read function used to sequentiallly read in data for iterating the database.
In this simple approach, the read function always returns a whole spectra xml string.
One obvious optimization would be, to read in smaller chunks of a spec string and jump to the next spectrum, as soon as the end of the current spectrum is reached (as exercise for the interested reader ;) ) .</p>
<p>Wrapper for accessing the database:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pymzml</span> <span class="kn">import</span> <span class="n">spec</span>
<span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="k">as</span> <span class="nn">et</span>
<span class="kn">from</span> <span class="nn">pymzml.run</span> <span class="kn">import</span> <span class="n">Reader</span>

<span class="k">class</span> <span class="nc">SQLiteDatabase</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Example implementation of a database Connector,</span>
<span class="sd">    which can be used to make run accept paths to</span>
<span class="sd">    sqlite db files.</span>

<span class="sd">    We initialize with a path to a database and implement</span>
<span class="sd">    a custom __getitem__ function to retrieve the spectra</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curr_spec_id</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT * FROM spectra WHERE id=?&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="n">ID</span><span class="p">,</span> <span class="n">element</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

        <span class="n">element</span> <span class="o">=</span> <span class="n">et</span><span class="o">.</span><span class="n">XML</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;spectrum&#39;</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span><span class="p">:</span>
            <span class="n">spectrum</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">Spectrum</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;chromatogram&#39;</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span><span class="p">:</span>
            <span class="n">spectrum</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">Chromatogram</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">spectrum</span>

    <span class="k">def</span> <span class="nf">get_spectrum_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT COUNT(*) from spectra&quot;</span><span class="p">)</span>
        <span class="n">num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">num</span>

    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="c1"># implement read so it starts reading in first ID,</span>
        <span class="c1"># if end reached switches to next id and so on ...</span>
        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_spectrum_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT * FROM spectra WHERE id=?&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="n">ID</span><span class="p">,</span> <span class="n">element</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_spectrum_id</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">element</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1"># This is what the Reader class does</span>
    <span class="n">my_iter</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">et</span><span class="o">.</span><span class="n">iterparse</span><span class="p">(</span><span class="n">SQLiteDatabase</span><span class="p">(</span><span class="s1">&#39;test.db&#39;</span><span class="p">)))</span>
    <span class="c1"># Now you can iter your database</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">my_iter</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="c1"># Retrieve a specific spectrum from your database</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">SQLiteDatabase</span><span class="p">(</span><span class="s1">&#39;test.db&#39;</span><span class="p">)</span>
    <span class="n">unique_id</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">my_spec</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">unique_id</span><span class="p">]</span>
</pre></div>
</div>
</section>
<section id="enabling-the-wrapper">
<h2><span class="section-number">4.6.2. </span>Enabling the wrapper<a class="headerlink" href="#enabling-the-wrapper" title="Link to this heading"></a></h2>
<p>In order to allow pymzML to use this new file class, the filehandler needs to be able to detect when to use this class.
The easiest way is, to add another elif statement which decides which handler to use based on the file path.
For this, edit the <code class="xref py py-func docutils literal notranslate"><span class="pre">_open()</span></code> method as shown in the following:</p>
<p>Code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Open a file like object resp. a wrapper for a file like object.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        path (str): path to the mzml file</span>

<span class="sd">    Returns:</span>
<span class="sd">        file_handler: instance of</span>
<span class="sd">        :py:class:`~pymzml.file_classes.standardGzip.StandardGzip`,</span>
<span class="sd">        :py:class:`~pymzml.file_classes.indexedGzip.IndexedGzip` or</span>
<span class="sd">        :py:class:`~pymzml.file_classes.standardMzml.StandardMzml`,</span>
<span class="sd">        based on the file ending of &#39;path&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.gz&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indexed_gzip</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="c1"># set offset_names and self.offsets</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file_handler</span> <span class="o">=</span> <span class="n">indexedGzip</span><span class="o">.</span><span class="n">IndexedGzip</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="c1"># for k, v in self.file_handler.index.items():</span>
            <span class="c1">#     self.offset_names.append( k )</span>
            <span class="c1">#     self.offsets.append( v )</span>
            <span class="c1"># self.offset_names   = [key for key in ra_reader.index.keys()]</span>
            <span class="c1"># self.offsets        = [off for off in ra_reader.index.values()]</span>
            <span class="c1">#, self.as_numpy</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file_handler</span> <span class="o">=</span> <span class="n">standardGzip</span><span class="o">.</span><span class="n">StandardGzip</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
    <span class="c1"># add your new elif statement here</span>
    <span class="k">elif</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;db&#39;</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">SQLiteConnector</span> <span class="kn">import</span> <span class="n">SQLiteDatabase</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_handler</span> <span class="o">=</span> <span class="n">SQLiteDatabase</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">encoding</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_handler</span>     <span class="o">=</span> <span class="n">standardMzml</span><span class="o">.</span><span class="n">StandardMzml</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_handler</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index_gzip.html" class="btn btn-neutral float-left" title="4.1. Writing and Reading igzip files" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="example_scripts.html" class="btn btn-neutral float-right" title="4.7. Example Scripts" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017, Kösters, M., Leufken, J., Schulze, S., Sugimoto, K., Zahedi, R. P., Hippler, M., Leidel, S. A. and Fufezan, C..</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>